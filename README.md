# SQL查询基数估计机器学习项目

## 项目概述

本项目实现了基于机器学习的SQL查询基数（cardinality）估计系统，用于预测SQL查询的结果集大小。项目提供了多种不同复杂度的解决方案，从简单的随机森林到高级的深度学习模型。

## 项目结构

```
├── data/
│   ├── train_data.json          # 训练数据（60000条样本）
│   ├── test_data.json           # 测试数据（1070条样本）
│   └── column_min_max_vals.csv  # 数据库列统计信息
├── refer_code/                  # 参考的MSCN实现
├── simple_train.py              # 简化版训练脚本
├── advanced_train.py            # 高级版训练脚本
├── data_processor.py            # 数据预处理模块
├── enhanced_model.py            # 增强的深度学习模型
├── train_enhanced_model.py      # 深度学习训练脚本
├── explore_data.py              # 数据探索脚本
├── requirements.txt             # 项目依赖
└── 预测结果_任宣宇_2023202303.csv # 最终预测结果
```

## 方法对比

### 1. 简化版本 (simple_train.py)
- **模型**: 随机森林
- **特征**: 基本查询特征（10维）
  - 查询长度、表数量、WHERE条件数、连接数
  - 查询计划中的成本、行数、节点类型
  - 数值范围特征
- **训练时间**: 快速
- **适用场景**: 快速原型和基线模型

### 2. 高级版本 (advanced_train.py) - **推荐使用**
- **模型**: 梯度提升回归
- **特征**: 丰富的特征工程（73维）
  - 基本查询特征（表数量、关键字统计等）
  - 表和列的one-hot编码
  - 谓词特征（操作符、数值范围、字符串常量）
  - 深度查询计划分析（结构、成本、节点类型）
  - 基于列统计信息的特征
- **数据量**: 使用30000个训练样本
- **预处理**: 特征标准化
- **性能**: 高精度预测

### 3. 深度学习版本 (train_enhanced_model.py)
- **模型**: 多头注意力 + 深度神经网络
- **特征**: SQL查询特征 + 查询计划特征
- **架构**: 
  - 独立的编码器处理不同类型特征
  - 多头注意力机制融合特征
  - 残差连接和dropout正则化
- **适用场景**: 需要最高精度的场景

## 快速开始

### 环境设置

```bash
# 安装依赖
pip install -r requirements.txt
```

### 数据探索

```bash
# 探索数据结构
python explore_data.py
```

### 训练和预测

#### 方法1: 简化版本（快速）
```bash
python simple_train.py
```

#### 方法2: 高级版本（推荐）
```bash
python advanced_train.py
```

#### 方法3: 深度学习版本
```bash
python train_enhanced_model.py --train_samples 20000 --epochs 50 --batch_size 128
```

## 技术特点

### 特征工程
1. **SQL查询特征**:
   - 词法分析：关键字统计、查询长度
   - 语法分析：表数量、连接条件、谓词数量
   - 语义分析：数值范围、字符串常量

2. **查询计划特征**:
   - 节点类型统计（扫描、连接、排序等）
   - 成本信息（启动成本、总成本）
   - 计划结构（深度、节点数量）
   - 基数估计（计划器预估的行数）

3. **统计特征**:
   - 基于数据库列统计信息
   - 表基数、列最值、唯一值数量

### 模型创新
1. **多模态特征融合**: 结合SQL文本和查询计划信息
2. **注意力机制**: 自动学习不同特征的重要性
3. **数值稳定性**: 使用log空间训练，避免数值溢出
4. **正则化**: Dropout和权重衰减防止过拟合

## 实验结果

最终提交的预测结果统计：
- **样本数量**: 1070
- **预测范围**: 1 - 163,593,316
- **中位数**: 345,265
- **平均值**: 3,616,898

## 文件说明

### 核心文件
- `advanced_train.py`: **主要训练脚本**，推荐使用
- `data_processor.py`: 数据预处理和特征提取
- `enhanced_model.py`: 深度学习模型定义

### 工具文件
- `explore_data.py`: 数据结构分析
- `simple_train.py`: 简化版基线模型

### 输出文件
- `预测结果_任宣宇_2023202303.csv`: 最终预测结果
- `best_model.pth`: 训练好的深度学习模型（如果使用）

## 性能优化

1. **训练效率**:
   - 使用tqdm显示进度
   - 多进程数据加载
   - GPU加速（如果可用）

2. **内存优化**:
   - 批处理数据加载
   - 特征向量稀疏化
   - 梯度累积

3. **数值稳定性**:
   - 输入特征标准化
   - 梯度裁剪
   - 预测值范围限制

## 扩展方向

1. **特征增强**:
   - 更复杂的SQL解析
   - 历史查询模式
   - 数据分布特征

2. **模型改进**:
   - Transformer架构
   - 图神经网络（查询计划图）
   - 集成学习

3. **实时优化**:
   - 在线学习
   - 增量更新
   - 查询缓存

## 作者信息

- **姓名**: 任宣宇
- **学号**: 2023202303
- **项目**: 机器学习大作业 - SQL查询基数估计

## 参考文献

1. Kipf et al., "Learned Cardinalities: Estimating Correlated Joins with Deep Learning", 2018
2. MSCN (Multi-Set Convolutional Networks) 原始实现
3. PostgreSQL查询计划分析方法